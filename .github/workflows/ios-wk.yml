name: iOS WKWebView IPA

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-ios:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          brew install xcodegen

      - name: Generate Xcode project
        working-directory: ios-wk
        run: |
          xcodegen generate
          echo "Before patch:"
          grep -m1 objectVersion XPortStore.xcodeproj/project.pbxproj || true
          # Жёстко понижаем формат проекта до совместимого с Xcode 15.x
          perl -0777 -pe 's/objectVersion = \d+/objectVersion = 60/g' -i XPortStore.xcodeproj/project.pbxproj
          echo "After patch:"
          grep -m1 objectVersion XPortStore.xcodeproj/project.pbxproj || true
          ls -la

      - name: Build .app (no code signing)
        working-directory: ios-wk
        run: |
          xcodebuild \
            -project XPortStore.xcodeproj \
            -scheme XPortStore \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY="" \
            build
          du -sh build/Build/Products/Release-iphoneos/XPortStore.app || true

      - name: Create unsigned .ipa
        run: |
          APP_PATH="ios-wk/build/Build/Products/Release-iphoneos/XPortStore.app"
          test -d "$APP_PATH"
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          zip -r XPortStore-WK.ipa Payload >/dev/null
          rm -rf Payload
          du -h XPortStore-WK.ipa || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: XPortStore-WK-ipa
          path: XPortStore-WK.ipa
          retention-days: 14
